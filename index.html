<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$']]
            }
        };
    </script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="graph">
            <h2>Harmonic Series</h2>
            <div id="harmonics"></div>
            <div class="edo-input-container">
            </div>
        </div>
        <div class="graph">
            <h2>Dissonance Graph</h2>
            <div id="dissonance"></div>
            <div class="edo-input-container">
                <label for="base-frequency">Base frequency (Hz): </label>
                <input type="number" id="base-frequency" min="20" max="20000" step="0.1" value="220">
            </div>
        </div>
        <div class="graph">
            <h2>EDO Alignment Error</h2>
            <div id="edo-error"></div>
            <div class="edo-input-container">
                <label for="min-edo-input">Min EDO: </label>
                <input type="number" id="min-edo-input" min="1" max="10000" value="3">
            </div>
            <div class="edo-input-container">
                <label for="max-edo-input">Max EDO: </label>
                <input type="number" id="max-edo-input" min="1" max="10000" value="53">
            </div>
        </div>
        <div class="graph">
            <h2>Harmonic Circle</h2>
            <div id="harmonic-circle"></div>
            <div class="edo-input-container">
                <label for="edo-input">EDO: </label>
                <input type="number" id="edo-input" min="5" max="100" value="12">
            </div>
        </div>
    </div>
    <div class="description">
        <h1>Musical Harmony Analysis Tool</h1>
        <h2>Features</h2>
        <p>This interactive tool helps explore musical harmony through four connected visualizations:</p>
        <ul>
            <li><strong>Harmonic Series:</strong> Drag the blue bars to adjust the strength of each harmonic. These changes affect how the sound will be produced.</li>
            <li><strong>Dissonance Graph:</strong> Shows how pleasant or harsh two notes sound together at different intervals. Click anywhere on the line to hear the sound. You can change the base note frequency below the graph.</li>
            <li>
                <strong>EDO Error Graph:</strong> Displays how well different Equal Division of Octave (EDO) systems match our harmonic series. Common Western music uses 12-EDO. Click any point to see its representation in the circle.
                <p>The error is calculated as the weighted distance of harmonics to the closest EDO note:</p>

                $$e = \sqrt{\sum_{n=1}^{+\infty}a_{n} (x_{n} - [x_{n}])^2}$$

                <p>where:</p>
                <ul>
                    <li>$a_n$ is the $n$-th harmonic amplitude</li>
                    <li>$x_n$ is the pitch value (in "semitones") $\rm{EDO} \times (\log_2(n) \bmod 1)$</li>
                </ul>
            </li>
            <li>
                <strong>Harmonic Circle:</strong> Shows harmonics arranged in a circle, with colors indicating how well they match the selected EDO system (green = good match, red = poor match). Blue lines show the EDO divisions.
                <p>Click on the circle to hear the sound of the selected note/harmonic.</p>
            </li>
        </ul>
        <h2>Advanced editing</h2>
        <h3>Number of harmonics</h3>
        <p>To set more harmonics than the default range, set the <code>harmonics</code> variable in the URL. For example, to set 80 harmonics, enter:</p>
        <h3>Custom series</h3>
        <pre><code>https://edo.jakim.it/?harmonics=80</code></pre>
        <p>If you want to provide non-standard (fractional) harmonics, or harmonics beyond the given range, you may use the console and edit the <code>harmonicSeries</code> variable directly. For example, you can add a single harmonic by:</p>
        <pre><code>harmonicSeries[1.5] = 0.5;</code></pre>
        <p>You can also provide the entire harmonic series as a dictionary:</p>
        <pre><code>harmonicSeries = {1: 1.0, 1.75: 0.25, 2.44: 0.1, 3: 0.05, 4.47: 0.02};</code></pre>
        <p>Update all graphs by calling:</p>
        <pre><code>updateAll();</code></pre>
        <p>Finally, you can provide a custom series via a URL in the following format:</p>
        <pre><code>https://edo.jakim.it/?1.0=1.0&1.75=0.25&2.44=0.1&3=0.05&4.47=0.02</code></pre>
        <p>where each harmonic is set by <code>harmonic=value</code> pairs, joined by <code>&</code>.</p>
    </div>
    <script src="audio.js"></script>
    <script src="dissonance.js"></script>
    <script src="analysis.js"></script>
</body>
</html>